!function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=function(){function e(t,r,o,i){var a=arguments.length<=4||void 0===arguments[4]?null:arguments[4],u=arguments.length<=5||void 0===arguments[5]?null:arguments[5],l=arguments.length<=6||void 0===arguments[6]?null:arguments[6];n(this,e),this.content=t,this.contentPath=r,this.apiKey=o,this.apiHost=i,this.createdAt=a,this.updatedAt=u,this.defaultContent=l,this.contentPath=this.contentPath.split(".").join("-")}return r(e,[{key:"isNew",value:function(){return!this.createdAt}},{key:"shouldUseParagraphs",value:function(){return this.defaultContent.indexOf("<p>")>=0?!0:""===this.defaultContent}}]),e}(),i=function(){function e(){n(this,e)}return r(e,[{key:"fetchContentBlocks",value:function(e,t,n){return jQuery.getJSON(t+"/v1/"+e+"/content_blocks?_="+this.cacheTime(n))}},{key:"storeContentBlock",value:function(e,t){return jQuery.ajax({url:e.apiHost+"/v1/"+e.apiKey+"/content_blocks",contentType:"application/json",dataType:"json",type:"POST",data:JSON.stringify({content_block:{content:e.content,content_path:e.contentPath},private_api_key:t}),headers:{"X-HTTP-Method-Override":"PUT"}})}},{key:"cacheTime",value:function(t){return t?Math.floor(this.currentTime()/e.MAX_CACHE_TTL)*e.MAX_CACHE_TTL:Math.round(this.currentTime())}},{key:"currentTime",value:function(){return Date.now()/1e3}},{key:"getRenuoUploadCredentials",value:function(e,t){return jQuery.getJSON(e.apiHost+"/v1/"+e.apiKey+"/renuo_upload_credentials?private_api_key="+t)}}]),e}();i.MAX_CACHE_TTL=120;var a=function(){function e(){n(this,e)}return r(e,[{key:"stringify",value:function(e){return JSON.stringify(e)}},{key:"parse",value:function(e){var t=JSON.parse(e);for(var n in t)t.hasOwnProperty(n)&&(t[n].created_at=new Date(t[n].created_at),t[n].updated_at=new Date(t[n].updated_at));return t}}]),e}(),u=function(){function e(){n(this,e),this.expiryDate={},this.serializer=new a}return r(e,[{key:"fetch",value:function(e){return this.serializer.parse(localStorage.getItem(e))}},{key:"put",value:function(e,t){this.skipStoring(e)||(this.setExpiryDate(e),localStorage.setItem(e,this.serializer.stringify(t)))}},{key:"skipStoring",value:function(e){return this.expiryDate[e]-this.timestamp()>0}},{key:"setExpiryDate",value:function(t){this.expiryDate[t]=this.timestamp()+e.EXPIRATIONTIME}},{key:"timestamp",value:function(){return Date.now()}}]),e}();u.EXPIRATIONTIME=36e5;var l=function(){function e(t,r){n(this,e),this.apiKey=t,this.signingUrl=r}return r(e,[{key:"hasCredentials",value:function(){return null!==this.apiKey&&this.apiKey.length>0&&null!==this.signingUrl&&this.signingUrl.length>0}}]),e}(),c=function(){function e(){n(this,e)}return r(e,[{key:"convertJson",value:function(e,t){return new o(t.content,t.content_path,t.api_key,e.apiHost,t.created_at,t.updated_at,e.defaultContent)}},{key:"extractObjectFromHash",value:function(e,t){var n=t[e.contentPath];return n?this.convertJson(e,n):e}},{key:"convertJsonObjectToHash",value:function(e){var t={};return e.content_blocks.reduce(function(e,t){return e[t.content_path]=t,e},t)}},{key:"convertJsonObjectToCredentials",value:function(e){var t=e.renuo_upload_credentials;return new l(t.api_key,t.signing_url)}}]),e}(),s=function T(e,t){n(this,T),this.contentBlock=e,this.renuoUploadCredentials=t},d=function(){function e(t){n(this,e),this.ajaxService=t,this.dataCache={},this.localStorageService=new u,this.renuoUploadCredentials={},this.dataConverter=new c}return r(e,[{key:"cacheKey",value:function(e,t){return[e.apiHost,e.apiKey,t].join("|")}},{key:"storeContent",value:function(e,t){return this.ajaxService.storeContentBlock(e,t)}},{key:"loadAllContents",value:function(e,t){var n=this;return this.ajaxService.fetchContentBlocks(e.apiKey,e.apiHost,t).then(function(e){return n.dataConverter.convertJsonObjectToHash(e)})}},{key:"loadReadonlyContent",value:function(e){return this.loadContent(e,!0)}},{key:"loadReadonlyContentFromCache",value:function(e){var t=this.cacheKey(e,!0),n=this.localStorageService.fetch(t);return n?this.dataConverter.extractObjectFromHash(e,n):e}},{key:"loadEditableContent",value:function(e,t){var n=this.loadContent(e,!1),r=this.loadRenuoUploadCredentials(e,t);return jQuery.when(n,r).then(function(e,t){return new s(e,t)})}},{key:"loadRenuoUploadCredentials",value:function(e,t){var n=this,r=this.cacheKey(e,!1);return this.renuoUploadCredentials[r]||(this.renuoUploadCredentials[r]=this.ajaxService.getRenuoUploadCredentials(e,t).then(function(e){return n.dataConverter.convertJsonObjectToCredentials(e)})),this.renuoUploadCredentials[r]}},{key:"loadContent",value:function(e,t){var n=this,r=this.cacheKey(e,t);return this.dataCache[r]||(this.dataCache[r]=this.loadAllContents(e,t)),this.dataCache[r].then(function(t){return n.localStorageService.put(r,t),n.dataConverter.extractObjectFromHash(e,t)})}}]),e}(),h=function(){function e(){n(this,e)}return r(e,[{key:"loadScript",value:function(e){return jQuery.getScript(e)}},{key:"loadRenuoUpload",value:function(){return this.loadScript("//cdn.rawgit.com/renuo/renuo-upload/1.1.0/dist/renuo_upload.min.js")}},{key:"loadCkeditor",value:function(){return this.loadScript("//cdn.ckeditor.com/4.5.5/full/ckeditor.js")}},{key:"loadDropzone",value:function(e){return this.loadScript("//cdn.jsdelivr.net/dropzone/"+e+"/dropzone.min.js")}}]),e}(),p=function(){function e(t){n(this,e),this.scriptLoader=t}return r(e,[{key:"loadEditor",value:function(){return this.scriptLoader.loadCkeditor()}}]),e}(),f=function(){function e(){n(this,e)}return r(e,[{key:"find",value:function(){return jQuery("[data-content-path]").toArray()}}]),e}(),v=function(){function e(t,r,o,i){n(this,e),this.element=t,this.contentBlock=r,this.privateApiKey=o,this.renuoUploadCredentials=i}return r(e,[{key:"isEditable",value:function(){return null!==this.privateApiKey}},{key:"hasRenuoUpload",value:function(){return null!==this.renuoUploadCredentials&&this.renuoUploadCredentials.hasCredentials()}}]),e}(),y=function(){function e(){n(this,e)}return r(e,[{key:"convert",value:function(e){var t=this.valueOf(e,"content-path"),n=this.valueOf(e,"api-key"),r=this.valueOf(e,"api-host"),i=this.extractPrivateApiKey(e),a=this.extractDefaultContent(e),u=new o("",t,n,r,null,null,a);return new v(e,u,i,null)}},{key:"extractPrivateApiKey",value:function(e){var t=this.valueOf(e,"private-api-key");return""===t?null:t}},{key:"valueOf",value:function(e,t){var n=e.attributes.getNamedItem("data-"+t);return null===n?null:n.value}},{key:"createNewBlock",value:function(e,t){return new v(e.element,t,e.privateApiKey,null)}},{key:"createNewEditableBlock",value:function(e,t){return new v(e.element,t.contentBlock,e.privateApiKey,t.renuoUploadCredentials)}},{key:"extractDefaultContent",value:function(e){return e.innerHTML}}]),e}(),k=function(){function e(){n(this,e)}return r(e,[{key:"draw",value:function(e){""===e.contentBlock.content&&e.contentBlock.isNew()||(e.element.innerHTML=e.contentBlock.content)}}]),e}(),m=function(){function e(){n(this,e)}return r(e,[{key:"addCSSToHead",value:function(e){jQuery("<link>",{rel:"stylesheet",type:"text/css",href:e}).appendTo("head")}},{key:"loadDropzoneCSS",value:function(e){this.addCSSToHead("//cdn.jsdelivr.net/dropzone/"+e+"/basic.min.css"),this.addCSSToHead("//cdn.jsdelivr.net/dropzone/"+e+"/dropzone.min.css")}}]),e}(),g=function(){function e(t,r){n(this,e),this.scriptLoader=t,this.cssInjector=r}return r(e,[{key:"loadUpload",value:function(){return this.cssInjector.loadDropzoneCSS(e.DROPZONE_VERSION),jQuery.when(this.scriptLoader.loadRenuoUpload(),this.scriptLoader.loadDropzone(e.DROPZONE_VERSION))}}]),e}();g.DROPZONE_VERSION="4.3.0";var C=function(){function e(t,r,o,i){n(this,e),this.dataService=t,this.loader=r,this.uploadLoader=o,this.preparer=i,this.loadingCallback=null}return r(e,[{key:"prepareEdit",value:function(e){var t=this;this.loadDependencies(),this.loadingCallback.done(function(){return t.preparer.prepare(e,function(e,n){return t.editContent(e,n)})})}},{key:"editContent",value:function(e,t){var n=this,r=e.contentBlock,i=new o(t,r.contentPath,r.apiKey,r.apiHost,r.createdAt,r.updatedAt,r.defaultContent);return this.dataService.storeContent(i,e.privateApiKey).then(function(){return n.preparer.notifySave(e,!0)}).fail(function(){return n.preparer.notifySave(e,!1)})}},{key:"loadDependencies",value:function(){null===this.loadingCallback&&(this.loadingCallback=jQuery.when(this.loader.loadEditor(),this.uploadLoader.loadUpload()))}}]),e}(),w=function(){function e(t,r,o,i){n(this,e),this.converter=t,this.dataService=r,this.drawer=o,this.editController=i}return r(e,[{key:"loadContent",value:function(e){var t=this;return this.dataService.loadEditableContent(e.contentBlock,e.privateApiKey).then(function(n){return t.handleElement(t.converter.createNewEditableBlock(e,n))})}},{key:"handleElement",value:function(e){this.drawer.draw(e),this.editController.prepareEdit(e)}}]),e}(),b=function(){function e(t,r,o){n(this,e),this.converter=t,this.dataService=r,this.drawer=o}return r(e,[{key:"loadContent",value:function(e){var t=this;return this.loadCachedContent(e),this.dataService.loadReadonlyContent(e.contentBlock).then(function(n){return t.handleElement(t.converter.createNewBlock(e,n))})}},{key:"loadCachedContent",value:function(e){var t=this.dataService.loadReadonlyContentFromCache(e.contentBlock);this.handleElement(this.converter.createNewBlock(e,t))}},{key:"handleElement",value:function(e){this.drawer.draw(e)}}]),e}(),S=function(){function e(t,r,o,i,a){n(this,e),this.finder=t,this.converter=r,this.dataService=o,this.drawer=i,this.editController=a}return r(e,[{key:"init",value:function(){var e=this,t=this.finder.find().map(function(t){return e.converter.convert(t)}),n=new w(this.converter,this.dataService,this.drawer,this.editController),r=new b(this.converter,this.dataService,this.drawer);t.forEach(function(e){return e.isEditable()?n.loadContent(e):void r.loadContent(e)})}}]),e}(),j=function(){function e(t){n(this,e),this.event=t}return r(e,[{key:"generateElement",value:function(){return this.isImage()?this.imageElement():this.anchorElement()}},{key:"isImage",value:function(){var e=["jpg","png","gif","jpeg","bmp","tiff","jp2","ico"];return e.indexOf(this.event.extension.toLowerCase())>-1}},{key:"imageElement",value:function(){var e=new Image;return e.src=this.event.publicUrl,e}},{key:"anchorElement",value:function(){var e=document.createElement("a");return e.href=this.event.publicUrl,e.innerText=this.event.cleanName,e}}]),e}(),z=function(){function e(t){n(this,e),this.domContentBlock=t}return r(e,[{key:"registerPlugin",value:function(e){var t=this;return this.domContentBlock.hasRenuoUpload()?(e.addCommand("renuoUpload",{exec:function(e){return t.openDropzone(e),!0}}),void e.ui.addButton("uploadButton",{label:"File/Image Upload",command:"renuoUpload",toolbar:"insert",icon:"image"})):!0}},{key:"closeDropzone",value:function(){jQuery("#dropzone-overlay").remove()}},{key:"openDropzone",value:function(e){var t=this,n=this.createDropzoneHTML();this.createDropzoneCSS(),jQuery("#dropzone-overlay").click(function(e){"dropzone-overlay"===$(e.target).attr("id")&&t.closeDropzone()}),new window.RenuoUpload(n,this.dropzoneOptions(),function(n){var r=new j(n).generateElement(),o=new CKEDITOR.dom.element(r);e.insertElement(o),t.closeDropzone()})}},{key:"dropzoneOptions",value:function(){return{acceptedFiles:"image/*,application/pdf",uploadMultiple:!1,maxFiles:1}}},{key:"createDropzoneHTML",value:function(){var e=jQuery('<div id="dropzone-overlay"> <div class="dropzone-container">   <div class="renuo-upload dz-clickable"></div> </div></div>'),t=this.domContentBlock.renuoUploadCredentials,n=jQuery(e).find(".renuo-upload");return n.attr("data-apikey",t.apiKey).attr("data-signingurl",t.signingUrl),jQuery("body").append(e),n}},{key:"createDropzoneCSS",value:function(){jQuery('<style type="text/css">#dropzone-overlay { top: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,.7); z-index: 10000; position: fixed; cursor: pointer; }.dropzone, .dropzone.dz-drag-hover { height:100%; border: none; }.dropzone-container { top: 25%; left: 25%; position: absolute; width: 50vw; border-radius: 5px; height: 50vh; padding:1em; background: #fff; z-index: 10001; margin: auto; cursor: default; }.dz-default { height:100%; border: 3px dashed #ccc; }.dropzone .dz-preview { width: 100%; }.dropzone .dz-default.dz-message { margin:0px; }.dropzone .dz-preview .dz-image { margin: auto; }.dz-default span { font-size: 2em; text-align: center; margin-top:3em; display: inline-block; }</style>').appendTo("head")}}]),e}(),E=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?null:arguments[0];n(this,e),this.ckeditor=t,jQuery('<style type="text/css">@keyframes renuo-cms-flash-success {0% { background: default; } 50% { background: #d7eed7; } 100% { background: default; }}@keyframes renuo-cms-flash-error {0% { background: default; } 50% { background: #f5d1d0; } 100% { background: default; }}.renuo-cms-edit-success{animation-name: renuo-cms-flash-success; animation-duration: 1.5s;}.renuo-cms-edit-error{animation-name: renuo-cms-flash-error; animation-duration: 1.5s;}</style>').appendTo("head")}return r(e,[{key:"prepare",value:function(e,t){null===this.ckeditor&&(this.ckeditor=CKEDITOR),"true"!==jQuery(e.element).attr("contenteditable")&&(jQuery(e.element).attr("contenteditable","true"),this.initCkeditor(e,t))}},{key:"notifySave",value:function(e,t){var n=t?"success":"error";jQuery(e.element).addClass("renuo-cms-edit-"+n).delay(2e3).queue(function(){return jQuery(e.element).removeClass("renuo-cms-edit-"+n).dequeue()})}},{key:"initCkeditor",value:function(e,t){var n=this,r=this.ckeditor.inline(e.element,this.ckeditorConfig(e.contentBlock));r.on("blur",function(r){return n.checkForUpdate(r,t,e)}),new z(e).registerPlugin(r)}},{key:"checkForUpdate",value:function(e,t,n){if(e.editor.checkDirty()){var r=e.editor.getData();e.editor.resetDirty(),t(n,r)}}},{key:"ckeditorConfig",value:function(e){return jQuery.extend({toolbarGroups:[{name:"styles",groups:["styles"]},{name:"basicstyles",groups:["basicstyles","cleanup"]},{name:"paragraph",groups:["list","indent","blocks","align","bidi","paragraph"]},{name:"links",groups:["links"]},{name:"insert",groups:["insert"]},{name:"clipboard",groups:["clipboard","undo"]},{name:"editing",groups:["find","selection","spellchecker","editing"]}],removePlugins:"bidi,font,forms,flash,horizontalrule,iframe",removeButtons:"Source,Save,NewPage,Preview,Templates,Print,SelectAll,Form,Checkbox,Radio,TextField,Textarea,Select,Button,HiddenField,Outdent,Indent,Blockquote,CreateDiv,BidiLtr,BidiRtl,Language,Anchor,WidgetbootstrapAlert,WidgetbootstrapThreeCol,WidgetbootstrapTwoCol,WidgetbootstrapRightCol,WidgetbootstrapLeftCol,Flash,ImageButton,Btgrid,Glyphicons,SpecialChar,Smiley,PageBreak,Iframe,Styles,Font,FontSize,TextColor,BGColor,Maximize,ShowBlocks,About,Image",format_tags:"p;h1;h2;h3;h4;h5;h6;pre;address"},this.enterMethod(e))}},{key:"enterMethod",value:function(e){return e.shouldUseParagraphs()?{}:{enterMode:CKEDITOR.ENTER_BR,shiftEnterMode:CKEDITOR.ENTER_P}}}]),e}();!function(){var e=function(){var e=new d(new i),t=new h,n=new m,r=new S(new f,new y,e,new k,new C(e,new p(t),new g(t,n),new E));r.init(),jQuery(document).on("renuo-cms-reload",function(){r.init()})};jQuery(e)}(),t["true"]=e}({},function(){return this}());